---
import { Icon } from 'astro-icon/components';

type SliderImage = {
	src: string;
	alt: string;
};

type Props = {
	class?: string;
	ariaLabel?: string;
	images?: SliderImage[];
	excludeChildren?: boolean;
};

const defaultAltTexts = [
	'Frequens - EMT para TDAH en Mérida',
	'Frequens - EMT para TDAH en Niños',
	'Frequens - EMT para TDAH en Adultos',
];

const defaultImages: SliderImage[] = [
	{ src: '/images/slider/emt-1.jpg', alt: defaultAltTexts[0] },
	{ src: '/images/slider/emt-nino-1.jpg', alt: defaultAltTexts[1] },
	{ src: '/images/slider/emt-nino-2.jpg', alt: defaultAltTexts[1] },
	{ src: '/images/slider/emt-nino-3.jpg', alt: defaultAltTexts[1] },
	{ src: '/images/slider/emt-nino-4.jpg', alt: defaultAltTexts[1] },
	{ src: '/images/slider/emt-adulto-1.jpg', alt: defaultAltTexts[2] },
	{ src: '/images/slider/emt-adulto-2.jpg', alt: defaultAltTexts[2] },
	{ src: '/images/slider/emt-adulto-3.jpg', alt: defaultAltTexts[2] },
	{ src: '/images/slider/emt-adulto-4.jpg', alt: defaultAltTexts[2] },
	{ src: '/images/slider/emt-adulto-5.jpg', alt: defaultAltTexts[2] },
];

const adultsOnlyImages: SliderImage[] = defaultImages.filter(img => !img.src.includes('nino'));

const { class: className = '', ariaLabel = 'Galería de imágenes', images: customImages, excludeChildren = false } = Astro.props;

const images = customImages ?? (excludeChildren ? adultsOnlyImages : defaultImages);

const sliderId = `hero-landing-slider-${crypto.randomUUID()}`;
const sliderHeight = 'h-[85svh] lg:h-[40svh]';
const sliderImageClass = 'w-full h-full object-cover object-center';
---

<section
	id={sliderId}
	class:list={[
		'relative w-full',
		'mb-12',
		sliderHeight,
		className,
	]}
	aria-label={ariaLabel}>
	<!-- Navigation arrows (Desktop only) -->
	<button
		type="button"
		class="hidden lg:flex absolute left-4 top-1/2 -translate-y-1/2 z-20
			w-12 h-12 items-center justify-center rounded-full
			bg-beige/95 ring-1 ring-main-200 shadow-warm-lg
			text-main-600 hover:bg-main-50 hover:ring-main-400 hover:text-main-700
			focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-main-500
			transition-all duration-300 cursor-pointer"
		data-slider-prev
		aria-label="Imagen anterior">
		<Icon
			name="chevron-down"
			class="w-6 h-6 rotate-90" />
	</button>

	<button
		type="button"
		class="hidden lg:flex absolute right-4 top-1/2 -translate-y-1/2 z-20
			w-12 h-12 items-center justify-center rounded-full
			bg-beige/95 ring-1 ring-main-200 shadow-warm-lg
			text-main-600 hover:bg-main-50 hover:ring-main-400 hover:text-main-700
			focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-main-500
			transition-all duration-300 cursor-pointer"
		data-slider-next
		aria-label="Imagen siguiente">
		<Icon
			name="chevron-down"
			class="w-6 h-6 -rotate-90" />
	</button>

	<!-- Slider track container -->
	<div
		class:list={[
		'overflow-hidden rounded-3xl bg-secondary-50 ring-1 ring-main-100 shadow-warm-lg touch-pan-y',
		sliderHeight,
	]}>
		<ul
			class="h-full flex will-change-transform transition-transform duration-500 ease-out"
			data-slider-track
			aria-live="polite">
			{
				images.map((img, idx) => (
					<li
						class="shrink-0 w-full lg:w-1/3 h-full p-2 lg:p-3"
						aria-label={`Imagen ${idx + 1} de ${images.length}`}
					>
						<div
							class="relative h-full w-auto mx-auto overflow-hidden rounded-2xl bg-main-50"
						>
							<img
								src={img.src}
								alt={img.alt}
								loading={idx < 3 ? 'eager' : 'lazy'}
								decoding="async"
								class={sliderImageClass}
							/>
							<!-- Subtle gradient overlay for depth -->
							<div
								class="pointer-events-none absolute inset-x-0 bottom-0 h-1/4
									bg-linear-to-t from-accent/25 to-transparent"
							/>
						</div>
					</li>
				))
			}
		</ul>
	</div>

	<!-- Mobile dots indicator -->
	<div
		class="mt-4 flex lg:hidden justify-center gap-2.5"
		aria-hidden="true">
		{images.map((_img, idx) => (
			<button
				type="button"
				class:list={[
					'h-2.5 w-2.5 rounded-full transition-all duration-300 cursor-pointer',
					'hover:scale-110 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-main-400',
					idx === 0 ? 'bg-main-500 scale-110' : 'bg-secondary-300 hover:bg-secondary-400',
				]}
				data-slider-dot
				data-index={idx}
				aria-label={`Ir a imagen ${idx + 1}`}
			/>
		))}
	</div>
</section>

<script
	is:inline
	define:vars={{ sliderId }}>
(() => {
	const root = document.getElementById(sliderId);
	if (!root) return;

	const track = root.querySelector('[data-slider-track]');
	const prevBtn = root.querySelector('[data-slider-prev]');
	const nextBtn = root.querySelector('[data-slider-next]');
	const dots = Array.from(root.querySelectorAll('[data-slider-dot]'));

	if (!track) return;

	const total = track.children.length;
	let index = 0;
	let isDragging = false;
	let startX = 0;
	let startTransformX = 0;

	const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
	const isDesktop = () => window.matchMedia('(min-width: 1024px)').matches;
	const perView = () => (isDesktop() ? 3 : 1);
	const maxIndex = () => Math.max(0, total - perView());

	const stepPx = () => {
		const width = root.getBoundingClientRect().width;
		return width / perView();
	};

	const updateDots = () => {
		dots.forEach((dot, i) => {
			const isActive = i === index;
			dot.classList.toggle('bg-main-500', isActive);
			dot.classList.toggle('scale-110', isActive);
			dot.classList.toggle('bg-secondary-300', !isActive);
		});
	};

	const currentTranslateX = () => {
		const transform = getComputedStyle(track).transform;
		if (!transform || transform === 'none') return 0;
		try {
			return new DOMMatrixReadOnly(transform).m41 || 0;
		} catch {
			return 0;
		}
	};

	const applyTransform = (animate = true) => {
		index = clamp(index, 0, maxIndex());
		const translateX = -(index * stepPx());
		track.style.transitionDuration = animate ? '' : '0ms';
		track.style.transform = `translate3d(${translateX}px, 0, 0)`;
		updateDots();
	};

	const navigate = (delta) => {
		index += delta;
		applyTransform();
	};

	const goToIndex = (targetIndex) => {
		index = targetIndex;
		applyTransform();
	};

	// Arrow button listeners
	prevBtn?.addEventListener('click', () => navigate(-1));
	nextBtn?.addEventListener('click', () => navigate(1));

	// Dot click listeners (mobile)
	dots.forEach((dot, i) => {
		dot.addEventListener('click', () => goToIndex(i));
	});

	// Touch swipe handlers (mobile)
	const onTouchStart = (e) => {
		if (isDesktop()) return;
		isDragging = true;
		startX = e.touches?.[0]?.clientX ?? 0;
		startTransformX = currentTranslateX();
		track.style.transitionDuration = '0ms';
	};

	const onTouchMove = (e) => {
		if (!isDragging) return;
		const currentX = e.touches?.[0]?.clientX ?? 0;
		const deltaX = currentX - startX;
		track.style.transform = `translate3d(${startTransformX + deltaX}px, 0, 0)`;
	};

	const onTouchEnd = (e) => {
		if (!isDragging) return;
		isDragging = false;
		const endX = e.changedTouches?.[0]?.clientX ?? startX;
		const deltaX = endX - startX;
		const threshold = Math.min(80, stepPx() * 0.2);

		if (deltaX > threshold) {
			index -= 1;
		} else if (deltaX < -threshold) {
			index += 1;
		}
		applyTransform();
	};

	// Attach touch event listeners
	root.addEventListener('touchstart', onTouchStart, { passive: true });
	root.addEventListener('touchmove', onTouchMove, { passive: true });
	root.addEventListener('touchend', onTouchEnd, { passive: true });

	// Handle window resize
	window.addEventListener('resize', () => applyTransform(false));

	// Initialize
	applyTransform(false);
})();
</script>
